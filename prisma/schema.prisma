generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== NUEVO SISTEMA DE COTIZACIONES =====

// Zones for geographic pricing
model Zone {
  id        String   @id @default(cuid())
  name      String   // "MEDELLIN", "BELLO-ITAGUI-ENVIGADO", etc.
  slug      String   @unique
  isMetro   Boolean  @default(true) // If it's metropolitan area
  rates     Rate[]
  createdAt DateTime @default(now())

  @@map("zones")
}

// Unified rates - handles zones AND out-of-city routes
model Rate {
  id            String         @id @default(cuid())
  zoneId        String
  zone          Zone           @relation(fields: [zoneId], references: [id])

  // Service type
  tripType      String       // SENCILLO or DOBLE
  equipmentType String       // RAMPA, ROBOTICA_PLEGABLE, or dynamic types

  // For zone-based pricing (Medellín, Área Metro)
  originType    String?      // DESDE_MEDELLIN or MISMO_MUNICIPIO
  distanceRange String?      // Only for Medellín: HASTA_3KM, DE_3_A_10KM, MAS_10KM

  // For out-of-city routes (when zone is "fuera-ciudad")
  destinationName String?    // "Aeropuerto JMC", "Rionegro", "Abejorral", etc.

  // Price in COP
  price         Int

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@map("rates")
}

// Additional services
model AdditionalService {
  id          String    @id @default(cuid())
  code        String    @unique
  name        String
  price       Int
  priceType   String    // FIJO, POR_HORA, POR_UNIDAD
  description String?

  @@map("additional_services")
}

// Surcharges
model Surcharge {
  id          String  @id @default(cuid())
  code        String  @unique // NOCTURNO, DOMINICAL_FESTIVO
  name        String
  price       Int
  description String?
  startHour   Int?    // Hora de inicio (0-23), ej: 18 para 6PM
  endHour     Int?    // Hora de fin (0-23), ej: 6 para 6AM

  @@map("surcharges")
}

// Out of city destinations (special rates)
model OutOfCityDestination {
  id            String        @id @default(cuid())
  name          String        // "Aeropuerto JMC", "Rionegro", "La Ceja"
  tripType      String
  equipmentType String
  originType    String?
  price         Int

  @@map("out_of_city_destinations")
}

// General pricing configuration
model PricingConfig {
  id                String @id @default(cuid())
  pricePerKm        Int    @default(8500)  // For out of city
  roboticSurcharge  Int    @default(40000) // Robotic wheelchair surcharge out of city

  @@map("pricing_config")
}

// Enums (using String since SQLite doesn't support native enums)
// TripType: SENCILLO (one way) | DOBLE (round trip)
// EquipmentType: RAMPA (vehicle with ramp) | ROBOTICA_PLEGABLE (robotic or foldable wheelchair)
// OriginType: DESDE_MEDELLIN (trip from Medellín to other municipality) | MISMO_MUNICIPIO (trip within same municipality)
// DistanceRange: HASTA_3KM (≤ 3 km) | DE_3_A_10KM (> 3 km and ≤ 10 km) | MAS_10KM (> 10 km)
// PriceType: FIJO (fixed price) | POR_HORA (multiplied by hours) | POR_UNIDAD (multiplied by quantity)

// ===== SISTEMA LEGACY (mantener compatibilidad) =====

model SurchargeRule {
  id            String        @id @default(cuid())
  name          String
  type          String        // NIGHT, SUNDAY_OR_HOLIDAY, ROBOTIC_CHAIR, etc.
  amountType    String        // FIXED, PER_UNIT, PERCENTAGE
  amount        Float
  unitLabel     String?
  conditionJson String?       // JSON as TEXT
  isActive      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@map("surcharge_rules")
}

model Holiday {
  id        String   @id @default(cuid())
  name      String
  date      DateTime
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date])
  @@map("holidays")
}

// Staff Management - Conductor + Vehiculo como unidad
model Staff {
  id           String   @id @default(cuid())
  name         String
  type         String   @default("DRIVER") // DRIVER (conductor con vehiculo)
  status       String   @default("AVAILABLE") // AVAILABLE, BUSY, OFFLINE, MAINTENANCE
  phone        String?
  email        String?
  color        String   @default("#3B82F6") // Color for calendar identification

  // Vehicle info (conductor + vehiculo son una unidad)
  licensePlate String?  // Placa del vehiculo
  vehicleModel String?  // Modelo del vehiculo
  capacity     Int?     // Capacidad de pasajeros
  isWheelchairAccessible Boolean @default(false) // Tiene rampa
  equipmentType String  @default("RAMPA") // RAMPA o ROBOTICA_PLEGABLE

  // Driver specific fields
  licenseNumber String?
  
  // Availability
  workDays     String   @default("1,2,3,4,5") // JSON: [1,2,3,4,5] = Mon-Fri
  workStartTime String  @default("07:00")      // HH:MM format
  workEndTime   String  @default("19:00")      // HH:MM format
  
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  appointments     Appointment[] @relation("StaffMember")
  unavailability   StaffUnavailability[]
  availability     StaffAvailability[]

  @@map("staff")
}

model StaffUnavailability {
  id        String   @id @default(cuid())
  staffId   String
  startTime DateTime
  endTime   DateTime
  reason    String?
  createdAt DateTime @default(now())

  staff Staff @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@map("staff_unavailability")
}

model StaffAvailability {
  id        String   @id @default(cuid())
  staffId   String
  dayOfWeek Int      // 0=Sunday, 1=Monday, etc.
  startTime String   // "09:00"
  endTime   String   // "18:00"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  staff Staff @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@map("staff_availability")
}

// Resources/Equipment management
model Resource {
  id           String   @id @default(cuid())
  name         String   // "Vehicle 1", "Chair 3", "Room A"
  description  String?
  type         String   @default("VEHICLE") // VEHICLE, EQUIPMENT, ROOM
  color        String   @default("#10B981")
  capacity     Int?     // Max people/items this resource can handle
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  appointments Appointment[] @relation("ResourceUsed")

  @@map("resources")
}

// Equipment Types - dynamic list of vehicle/service equipment
model EquipmentType {
  id          String   @id @default(cuid())
  name        String   // "Vehículo con Rampa", "Silla Robótica/Plegable", etc.
  slug        String   @unique  // "RAMPA", "ROBOTICA_PLEGABLE", etc.
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("equipment_types")
}

// Enhanced Customer model
model Customer {
  id                 String   @id @default(cuid())
  name               String
  email              String?  @unique
  phone              String
  document           String?

  // Physical info for service
  age                Int?
  weight             Float?            // Peso aproximado en kg
  wheelchairType     String?           // Tipo de silla: propia, alquilada, ninguna, etc.

  // Additional info
  emergencyContact   String?
  medicalNotes       String?
  mobilityNeeds      String?  // JSON: ["wheelchair", "walker"]
  preferredLanguage  String   @default("es")

  // Default address
  defaultAddress     String?
  defaultLat         Float?
  defaultLng         Float?

  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  appointments Appointment[]

  @@map("customers")
}

// Legacy service model (keep for compatibility)
model Service {
  id               String        @id @default(cuid())
  name             String        @unique
  description      String?
  durationMinutes  Int
  color            String        @default("#3B82F6")
  requiresVehicle  Boolean       @default(true)
  isActive         Boolean       @default(true)
  
  // Pricing fields
  basePrice        Float?        // Base price for the service
  category         String?       // SENCILLO, DOBLE, ROBOTICA_PLEGABLE, etc.
  
  // Distance range fields
  minDistanceKm    Float?        // Minimum distance for this service
  maxDistanceKm    Float?        // Maximum distance for this service
  
  // Floor range fields (for building services)
  minFloor         Int?          // Minimum floor
  maxFloor         Int?          // Maximum floor
  
  // Service characteristics
  isHourly         Boolean       @default(false) // If service is charged hourly
  
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  appointments     Appointment[]

  @@map("services")
}

// Enhanced Appointment model (Brisk-style)
model Appointment {
  id                    String            @id @default(cuid())
  serviceId             String?           // Optional - legacy, equipment type now comes from staff
  customerId            String
  staffId               String?           // Assigned staff member
  resourceId            String?           // Assigned resource/vehicle
  equipmentType         String            @default("RAMPA")  // RAMPA or ROBOTICA_PLEGABLE - from conductor

  // Location details
  originAddress         String
  originLat             Float
  originLng             Float
  destinationAddress    String
  destinationLat        Float
  destinationLng        Float

  // Scheduling
  scheduledAt           DateTime
  returnAt              DateTime?         // Return pickup time for round trips (DOBLE)
  estimatedDuration     Int
  actualStartTime       DateTime?
  actualEndTime         DateTime?

  // Pricing
  distanceKm            Float
  pricingSnapshot       String            // JSON as TEXT
  totalAmount           Float

  // Status and notes
  status                String            @default("PENDING") // PENDING, CONFIRMED, etc.
  notes                 String?
  internalNotes         String?           // Staff notes

  // Customer satisfaction
  rating                Int?              // 1-5 stars
  feedback              String?

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  service         Service?  @relation(fields: [serviceId], references: [id])
  customer        Customer  @relation(fields: [customerId], references: [id])
  staff           Staff?    @relation("StaffMember", fields: [staffId], references: [id])
  resource        Resource? @relation("ResourceUsed", fields: [resourceId], references: [id])

  @@map("appointments")
}

// System settings
model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}

// ===== AUTHENTICATION =====

// Admin users
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String
  role          String    @default("ADMIN") // ADMIN, SUPER_ADMIN
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  sessions      Session[]

  @@map("users")
}

// User sessions
model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}